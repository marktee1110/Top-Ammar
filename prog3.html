<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ğŸ’¯ - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ù…Ø§Ø± ÙŠÙˆØ³Ù</title>
  <style>
    :root{--main:#8B5E3C;--danger:#ef4444}  /* Ø¨Ù†ÙŠ Ù…ØªÙˆØ³Ø· */
    body{margin:0;font-family:system-ui,"Segoe UI",sans-serif;background:#f8fafc;color:#0f172a}
    header{background:var(--main);color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700}
    nav{
      display:flex;
      gap:8px;
      justify-content:flex-start;
      padding:8px;
      background:#fff;
      border-bottom:1px solid #e6e6e6;
    }
    nav button{
      background:#fff;
      border:1px solid transparent;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      color:#64748b;
    }
    nav button.active{
      color:var(--main);
      font-weight:700;
      background:rgba(139,94,60,0.06);
      border-color:rgba(139,94,60,0.12);
    }
    .container{max-width:980px;margin:20px auto;padding:0 12px}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 1px 3px rgba(2,6,23,0.06);margin-bottom:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{padding:10px;border:1px solid #cbd5e1;border-radius:6px;width:100%;margin-bottom:8px;font-size:15px}
    .btn{padding:10px 12px;border:none;border-radius:6px;cursor:pointer;font-size:15px}
    .btn.main{background:var(--main);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #cbd5e1}
    .btn.danger{background:var(--danger);color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{
      border:1px solid #e2e8f0;
      padding:10px;
      text-align:center;
      font-size:16px;
      font-weight:600;
      color:#0b1220;
    }
    tbody tr:nth-child(odd){ background:#ffffff; }
    tbody tr:nth-child(even){ background:#f1f5f9; }
    @media (max-width:700px){
      .row{flex-direction:column}
      .input{width:100%}
    }
  </style>
</head>
<body>
<header>ğŸ“ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ğŸ’¯ - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ù…Ø§Ø± ÙŠÙˆØ³Ù</header> 

<nav>
  <button onclick="location.href='index.html'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</nav>

<div class="container">
  <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª -->
  <div class="card">
    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h3>
    <div class="row">
      <select id="sessionsDropdown3" class="input" style="max-width:260px"></select>
      <button id="btnNewSession3" class="btn main">â• Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button id="btnSaveSession3" class="btn ghost">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button id="btnDeleteSession3" class="btn danger">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>
  </div>

  <!-- Ø§Ù„ÙˆÙ‚ÙØ© -->
  <div class="card">
    <h3>Ø§Ù„ÙˆÙ‚ÙØ©</h3>
    <input id="stand_name_3" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆÙ‚ÙØ©" list="pointsList3" />
    <input id="stand_x_3" class="input" type="number" placeholder="X Ø§Ù„ÙˆÙ‚ÙØ© (Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¬Ø¨Ø©ØŒ Ø³ÙŠØ¹Ø§Ù…Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ X ÙƒØ³Ø§Ù„Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹)" />
    <input id="stand_y_3" class="input" type="number" placeholder="Y Ø§Ù„ÙˆÙ‚ÙØ©" />
    <div class="row">
      <button id="btnSaveStand3" class="btn main">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚ÙØ©</button>
      <button id="btnUpdate31" class="btn ghost">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø²ÙŠØ±Ùˆ -->
  <div class="card">
    <h3>Ø§Ù„Ø²ÙŠØ±Ùˆ</h3>
    <input id="zero_name_3" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²ÙŠØ±Ùˆ" list="pointsList3" />
    <input id="zero_x_3" class="input" type="number" placeholder="X Ø§Ù„Ø²ÙŠØ±Ùˆ (Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¬Ø¨Ø©)" />
    <input id="zero_y_3" class="input" type="number" placeholder="Y Ø§Ù„Ø²ÙŠØ±Ùˆ" />
    <div class="row">
      <button id="btnSaveZero3" class="btn main">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ±Ùˆ</button>
      <button id="btnUpdate32" class="btn ghost">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø· -->
  <datalist id="pointsList3"></datalist>

  <!-- Ù†Ù‚Ø·Ø© ØªØ­Ù‚ÙŠÙ‚ -->
  <div class="card">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ØªØ­Ù‚ÙŠÙ‚ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</h3>
    <input id="invest_name_3" class="input" placeholder="Ø§Ø³Ù… Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
    <input id="invest_x_3" class="input" type="number" placeholder="X Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ (Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¬Ø¨Ø©ØŒ Ø³ÙŠØ¹Ø§Ù…Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ X ÙƒØ³Ø§Ù„Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹)" />
    <input id="invest_y_3" class="input" type="number" placeholder="Y Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚" />
    <div class="row">
      <button id="btnAddInvest3" class="btn main">â• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ØªØ­Ù‚ÙŠÙ‚</button>
      <button id="btnClearInvest3" class="btn ghost">Ù…Ø³Ø­</button>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
  <div class="card">
    <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</h3>
    <table id="table_prog3">
      <thead>
        <tr><th>#</th><th>Ø§Ø³Ù… Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</th><th>X</th><th>Y</th><th>Ø§Ù„Ø²Ø§ÙˆÙŠØ© (ØºØ±Ø§Ø¯)</th><th>ØªØ­ÙƒÙ…</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button id="btnExportCSV3" class="btn ghost">ğŸ“„ ØªØµØ¯ÙŠØ± CSV</button>
      <button id="btnExportPTS3" class="btn ghost">ğŸ“„ ØªØµØ¯ÙŠØ± PTS</button>
      <button id="btnExportWGS843" class="btn ghost">ğŸŒ ØªØµØ¯ÙŠØ± WGS84</button>
    </div>
  </div>

</div>

<script>
(function(){
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø³Ù‚Ø§Ø·
  var deirEzzorProj = "+proj=utm +zone=37 +datum=WGS84 +units=m +no_defs";
  var wgs84Proj = "+proj=longlat +datum=WGS84 +no_defs";

  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  var STORAGE_KEY_SESSIONS = "sessions_prog3";
  var POINTS_DB_KEY = "pointsDB"; // Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬
  var sessions = [];
  var currentInvestigations = [];

  // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
  function getEl(id){ return document.getElementById(id); }
  function safeParse(raw){ try { return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
  function saveFile(content, name){
    var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); }, 500);
  }
  function pad(n){ return String(n).padStart(2,"0"); }
  function fileName(base, ext){
    var d = new Date();
    return base + "_" + d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + "_" + pad(d.getHours()) + "-" + pad(d.getMinutes()) + "." + ext;
  }

  // Ø¬Ù„Ø³Ø§Øª
  function loadSessions(){
    sessions = safeParse(localStorage.getItem(STORAGE_KEY_SESSIONS));
  }
  function saveSessions(){
    localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions));
  }
  function refreshSessionsDropdown3(){
    var dd = getEl("sessionsDropdown3");
    dd.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©...</option>';
    sessions.forEach(function(s,i){
      var opt = document.createElement("option");
      opt.value = i;
      opt.textContent = (s.name || ("Ø¬Ù„Ø³Ø© "+(i+1))) + " â€” " + (s.date || "");
      dd.appendChild(opt);
    });
  }
  function newSession3(){
    var s = {name:"Ø¬Ù„Ø³Ø© "+(sessions.length+1), desc:"", date:new Date().toLocaleString(), investigations:[], stand:{}, zero:{}};
    sessions.push(s);
    saveSessions();
    refreshSessionsDropdown3();
    getEl("sessionsDropdown3").value = String(sessions.length-1);
    loadSession3(sessions.length-1);
    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø¨Ù‡Ø§");
  }
  function saveSession3(){
    var dd = getEl("sessionsDropdown3");
    if(dd.value===""){ alert("Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©"); return; }
    var idx = parseInt(dd.value,10);
    var s = sessions[idx];
    var name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©", s.name || "");
    if(!name){ return; }
    var desc = prompt("Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ù„Ù„Ø¬Ù„Ø³Ø©", s.desc || "");
    s.name = name;
    s.desc = desc || "";
    s.date = new Date().toLocaleString();
    s.investigations = currentInvestigations.slice();
    // Ù†Ø®Ø²Ù† Ù‚ÙŠÙ… Ø§Ù„ÙˆÙ‚ÙØ© ÙˆØ§Ù„Ø²ÙŠØ±Ùˆ ÙƒÙ…Ø§ Ø£Ø¯Ø®Ù„Ù‡Ø§ (Ù…ÙˆØ¬Ø¨Ø©) Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹
    s.stand = {
      name:getEl("stand_name_3").value,
      x:parseFloat(getEl("stand_x_3").value),
      y:parseFloat(getEl("stand_y_3").value)
    };
    s.zero = {
      name:getEl("zero_name_3").value,
      x:parseFloat(getEl("zero_x_3").value),
      y:parseFloat(getEl("zero_y_3").value)
    };
    saveSessions();
    refreshSessionsDropdown3();
    dd.value = String(idx);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©");
  }

  function deleteSession3(){
    var dd = getEl("sessionsDropdown3");
    if(dd.value===""){ alert("Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©"); return; }
    var idx = parseInt(dd.value,10);
    sessions.splice(idx,1);
    saveSessions();
    refreshSessionsDropdown3();
    dd.value = "";
    currentInvestigations = [];
    renderTable();
    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©");
  }

  function loadSession3(index){
    var s = sessions[index];
    if(!s){ return; }
    currentInvestigations = (s.investigations || []).slice();
    renderTable();
    // Ù†Ø¹Ø±Ø¶ Ù‚ÙŠÙ… Ø§Ù„ÙˆÙ‚ÙØ© ÙˆØ§Ù„Ø²ÙŠØ±Ùˆ ÙƒÙ…Ø§ Ø£Ø¯Ø®Ù„Ù‡Ø§ (Ù…ÙˆØ¬Ø¨Ø©) Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    getEl("stand_name_3").value = (s.stand && s.stand.name) ? s.stand.name : "";
    getEl("stand_x_3").value   = (s.stand && typeof s.stand.x !== "undefined") ? s.stand.x : "";
    getEl("stand_y_3").value   = (s.stand && typeof s.stand.y !== "undefined") ? s.stand.y : "";
    getEl("zero_name_3").value = (s.zero && s.zero.name) ? s.zero.name : "";
    getEl("zero_x_3").value    = (s.zero && typeof s.zero.x !== "undefined") ? s.zero.x : "";
    getEl("zero_y_3").value    = (s.zero && typeof s.zero.y !== "undefined") ? s.zero.y : "";
  }

  // Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ù‚ÙŠÙ‚: Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ©ØŒ ÙˆØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© + pointsDB
  function addInvestigation(){
    var name = (getEl("invest_name_3").value || "").trim() || "-";
    var tx_input = parseFloat(getEl("invest_x_3").value);
    var ty = parseFloat(getEl("invest_y_3").value);

    var sx_input = parseFloat(getEl("stand_x_3").value);
    var sy = parseFloat(getEl("stand_y_3").value);
    var zx_input = parseFloat(getEl("zero_x_3").value);
    var zy = parseFloat(getEl("zero_y_3").value);

    var vals = [tx_input, ty, sx_input, sy, zx_input, zy];
    for(var i=0;i<vals.length;i++){ if(isNaN(vals[i])){ alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆÙ‚ÙØ©ØŒ Ø§Ù„Ø²ÙŠØ±ÙˆØŒ ÙˆØ¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ ØµØ­ÙŠØ­Ø©"); return; } }

    // ØªØ­ÙˆÙŠÙ„ X Ø¥Ù„Ù‰ Ø³Ø§Ù„Ø¨Ø© Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
    var sx = -Math.abs(sx_input);
    var zx = -Math.abs(zx_input);
    var tx = -Math.abs(tx_input);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ÙÙ‚Ø·
    var zeroDir = Math.atan2(zy - sy, zx - sx);
    var targetDir = Math.atan2(ty - sy, tx - sx);
    var angleGrad = (targetDir - zeroDir) * 200 / Math.PI;
    if(angleGrad < 0) angleGrad += 400;
    angleGrad = Number(angleGrad.toFixed(4));

    // Ù†Ø®Ø²Ù† Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙƒÙ€ ØªØ­Ù‚ÙŠÙ‚)
    currentInvestigations.push({
      name: name,
      x: tx,
      y: ty,
      angle: angleGrad
    });

    // ÙˆÙ†Ø®Ø²Ù†Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    addPointToPointsDBIfMissing({ name: name, x: Math.abs(tx), y: ty });

    renderTable();
    clearInvestInputs();
    alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ ÙˆØ­ÙØ¸Ù‡Ø§");
  }

  function clearInvestInputs(){
    getEl("invest_name_3").value = "";
    getEl("invest_x_3").value = "";
    getEl("invest_y_3").value = "";
  }

  function removeInvest(i){
    currentInvestigations.splice(i,1);
    renderTable();
  }

  function renderTable(){
    var tbody = getEl("table_prog3").querySelector("tbody");
    tbody.innerHTML = "";
    currentInvestigations.forEach(function(t,i){
      var tr = document.createElement("tr");
      tr.innerHTML =
        "<td>"+(i+1)+"</td>"+
        "<td>"+t.name+"</td>"+
        "<td>"+t.x.toFixed(3)+"</td>"+
        "<td>"+t.y.toFixed(3)+"</td>"+
        "<td>"+t.angle.toFixed(4)+"</td>"+
        "<td><button class='btn danger' data-idx='"+i+"'>ğŸ—‘ Ø­Ø°Ù</button></td>";
      tbody.appendChild(tr);
    });
    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    Array.prototype.forEach.call(tbody.querySelectorAll("button[data-idx]"), function(b){
      b.addEventListener("click", function(){
        var idx = parseInt(this.getAttribute("data-idx"),10);
        removeInvest(idx);
      });
    });
  }

  // Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚ÙØ©/Ø§Ù„Ø²ÙŠØ±Ùˆ ÙƒØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø·
  function saveStand3(){
    var name = getEl("stand_name_3").value.trim();
    var x = parseFloat(getEl("stand_x_3").value);
    var y = parseFloat(getEl("stand_y_3").value);
    if(!name || isNaN(x) || isNaN(y)){ alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ÙˆÙ‚ÙØ©"); return; }
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚ÙØ©");
  }
  function saveZero3(){
    var name = getEl("zero_name_3").value.trim();
    var x = parseFloat(getEl("zero_x_3").value);
    var y = parseFloat(getEl("zero_y_3").value);
    if(!name || isNaN(x) || isNaN(y)){ alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø²ÙŠØ±Ùˆ"); return; }
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ±Ùˆ");
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ù„ÙƒÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  function updateResults3(){
    var proceed = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ");
    if(!proceed){ alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); return; }

    var sx_input = parseFloat(getEl("stand_x_3").value);
    var sy = parseFloat(getEl("stand_y_3").value);
    var zx_input = parseFloat(getEl("zero_x_3").value);
    var zy = parseFloat(getEl("zero_y_3").value);

    var vals = [sx_input, sy, zx_input, zy];
    for(var i=0;i<vals.length;i++){ if(isNaN(vals[i])){ alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ÙˆÙ‚ÙØ© ÙˆØ§Ù„Ø²ÙŠØ±Ùˆ"); return; } }

    var sx = -Math.abs(sx_input);
    var zx = -Math.abs(zx_input);

    currentInvestigations = currentInvestigations.map(function(t){
      var tx = t.x;
      var ty = t.y;
      var zeroDir = Math.atan2(zy - sy, zx - sx);
      var targetDir = Math.atan2(ty - sy, tx - sx);
      var angleGrad = (targetDir - zeroDir) * 200 / Math.PI;
      if(angleGrad < 0) angleGrad += 400;
      return { name: t.name, x: tx, y: ty, angle: Number(angleGrad.toFixed(4)) };
    });

    renderTable();
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­");
  }

  // Ù†Ù‚Ø§Ø· Ù…Ø±Ø¬Ø¹ÙŠØ© (pointsDB)
  function loadPointsSuggestions(){
    var points = safeParse(localStorage.getItem(POINTS_DB_KEY));
    var dl = getEl("pointsList3");
    dl.innerHTML = "";
    points.forEach(function(p){
      var opt = document.createElement("option");
      opt.value = p.name;
      dl.appendChild(opt);
    });
  }
  function applyPointData3(inputId){
    var name = getEl(inputId).value.trim();
    var points = safeParse(localStorage.getItem(POINTS_DB_KEY));
    var p = points.find(function(pt){ return pt.name === name; });
    if(p){
      if(inputId === "stand_name_3"){
        getEl("stand_x_3").value = p.x;
        getEl("stand_y_3").value = p.y;
      }else if(inputId === "zero_name_3"){
        getEl("zero_x_3").value = p.x;
        getEl("zero_y_3").value = p.y;
      }else if(inputId === "invest_name_3"){
        // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ù†Ù‚Ø·Ø© ØªØ­Ù‚ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªØŒ Ù†Ù…Ù„Ø£ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        getEl("invest_x_3").value = p.x;
        getEl("invest_y_3").value = p.y;
      }
    }
  }
  function addPointToPointsDBIfMissing(point){
    if(!point || !point.name) return;
    var points = safeParse(localStorage.getItem(POINTS_DB_KEY));
    var exists = points.some(function(p){ return p.name === point.name; });
    if(!exists){
      // Ù†Ø®Ø²Ù† X Ù…ÙˆØ¬Ø¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (ÙƒÙ…Ø§ ÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
      points.push({ name: point.name, x: Number(point.x), y: Number(point.y) });
      localStorage.setItem(POINTS_DB_KEY, JSON.stringify(points));
      loadPointsSuggestions();
    }
  }

  // ØªØµØ¯ÙŠØ±
  function convertPointsToWGS84(points){
    return points.map(function(p,i){
      var res = proj4(deirEzzorProj, wgs84Proj, [Number(p.x), Number(p.y)]);
      return { id: p.name || ("P"+(i+1)), lon: res[0], lat: res[1] };
    });
  }
  function exportCSV3(){
    if(!currentInvestigations.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø·"); return; }
    var lines = ["id,x,y,angle"];
    currentInvestigations.forEach(function(t,i){
      lines.push((t.name||("P"+(i+1)))+","+t.x.toFixed(3)+","+t.y.toFixed(3)+","+t.angle.toFixed(4));
    });
    saveFile(lines.join("\n"), fileName("prog3","csv"));
  }
  function exportPTS3(){
    if(!currentInvestigations.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø·"); return; }
    var gps = convertPointsToWGS84(currentInvestigations);
    var lines = gps.map(function(p){ return p.id+", "+p.lon.toFixed(8)+", "+p.lat.toFixed(8)+", 0.00, -26.5"; });
    saveFile(lines.join("\n"), fileName("prog3","pts"));
  }
  function exportWGS843(){
    if(!currentInvestigations.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø·"); return; }
    var gps = convertPointsToWGS84(currentInvestigations);
    var lines = gps.map(function(p){ return p.id+", "+p.lon.toFixed(8)+", "+p.lat.toFixed(8)+", 0.00, -26.5"; });
    saveFile(lines.join("\n"), fileName("prog3","global.pts"));
  }

  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  function bindEvents(){
    getEl("btnNewSession3").addEventListener("click", newSession3);
    getEl("btnSaveSession3").addEventListener("click", saveSession3);
    getEl("btnDeleteSession3").addEventListener("click", deleteSession3);
    getEl("sessionsDropdown3").addEventListener("change", function(){
      if(this.value!==""){ loadSession3(parseInt(this.value,10)); }
    });

    getEl("btnSaveStand3").addEventListener("click", saveStand3);
    getEl("btnSaveZero3").addEventListener("click", saveZero3);
    getEl("btnUpdate31").addEventListener("click", updateResults3);
    getEl("btnUpdate32").addEventListener("click", updateResults3);

    getEl("btnAddInvest3").addEventListener("click", addInvestigation);
    getEl("btnClearInvest3").addEventListener("click", clearInvestInputs);

    getEl("stand_name_3").addEventListener("change", function(){ applyPointData3("stand_name_3"); });
    getEl("zero_name_3").addEventListener("change", function(){ applyPointData3("zero_name_3"); });
    getEl("invest_name_3").addEventListener("change", function(){ applyPointData3("invest_name_3"); });

    getEl("btnExportCSV3").addEventListener("click", exportCSV3);
    getEl("btnExportPTS3").addEventListener("click", exportPTS3);
    getEl("btnExportWGS843").addEventListener("click", exportWGS843);
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  document.addEventListener("DOMContentLoaded", function(){
    loadSessions();
    refreshSessionsDropdown3();
    loadPointsSuggestions();
    bindEvents();
    renderTable();
  });
})();
</script>
</body>
</html>