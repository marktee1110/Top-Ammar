<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ù…Ø§Ø± ÙŠÙˆØ³Ù</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--main:#0ea5e9;--danger:#ef4444}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f8fafc;color:#0f172a;margin:0}
    header{background:var(--main);color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700}
    nav{
      display:flex;
      justify-content:center;
      gap:12px;
      padding:10px;
      background:#fff;
      border-bottom:1px solid #e6e6e6;
    }
    nav button{
      background:#fff;
      border:1px solid transparent;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      color:#64748b;
    }
    nav button.active{
      color:var(--main);
      font-weight:700;
      background:rgba(14,165,233,0.06);
      border-color:rgba(14,165,233,0.12);
    }
    .card{background:#fff;padding:16px;margin:20px;border-radius:10px;box-shadow:0 2px 6px rgba(2,6,23,0.06)}
    input,select,textarea,button{font-size:15px}
    input,select,textarea{padding:10px;margin:6px 4px;border:1px solid #cbd5e1;border-radius:8px}
    textarea{width:100%;min-height:80px;resize:vertical}
    button{padding:10px 14px;margin:6px 4px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .btn-main{background:#0ea5e9;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-edit{background:#f59e0b;color:#fff}
    .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0b122a}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e2e8f0;padding:12px;text-align:center;font-size:16px;font-weight:700;color:#0b122a}
    th{background:#e2e8f0}
    tbody tr:nth-child(even){background:#f1f5f9}
    #sessionDetails{display:none;margin-top:20px}
    pre{white-space:pre-wrap;font-weight:600}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .small{font-size:13px;color:#334155}
    .separator-row{background:#334155;color:#fff;font-weight:800}
    @media (max-width:700px){
      th,td{font-size:14px;padding:8px}
      input,textarea,button{font-size:14px}
    }
  </style>
</head>
<body>
<header>ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª - Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ù…Ø§Ø± ÙŠÙˆØ³Ù</header>

<nav>
  <button onclick="location.href='index.html'" class="active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</nav>

  <!-- Ù…ÙƒØªØ¨Ø© Excel (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>


<div class="card">
  <h2>Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø©</h2>
  <div class="controls-row">
    <input id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" style="flex:2" oninput="applyFilters()">
    <select id="programFilter" onchange="applyFilters()" style="flex:1">
      <option value="">-- ÙƒÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ --</option>
    </select>
    <select id="dateFilter" onchange="applyFilters()" style="flex:1">
      <option value="">-- ÙƒÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® --</option>
      <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
      <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
    </select>
    <button class="btn-main" onclick="toggleSortOrder()">ğŸ“… ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
  </div>
</div>

<div class="card">
  <div class="controls-row" style="justify-content:space-between;align-items:center">
    <div style="flex:1">
      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h2>
      <select id="sessionSelect" onchange="selectSession()" style="width:100%;padding:10px;border-radius:8px">
        <option value="">-- Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø© --</option>
      </select>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-left:12px">
      <button class="btn-edit" onclick="toggleControls()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
      <div style="display:flex;gap:8px">
        <button class="btn-main" onclick="exportAllSessions()">ğŸ“Š ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
        <button class="btn-main" onclick="confirmImport()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
        <input type="file" id="importExcel" accept=".xlsx" style="display:none" onchange="importExcel()" />
      </div>
    </div>
  </div>

  <table id="table_sessions">
    <thead>
      <tr id="theadRow"><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="sessionDetails" class="card">
  <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
  <div class="controls-row" style="justify-content:space-between;align-items:flex-start">
    <pre id="sessionInfo" style="flex:1"></pre>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn-main" onclick="exportCurrentSession()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button class="btn-edit" onclick="openEditDetails()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button class="btn-danger" onclick="confirmDeleteCurrent()">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>
  </div>
  <div id="sessionPoints" style="margin-top:12px"></div>
</div>

<script>
/ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ø´ØªØ±ÙƒØ© Ø¹Ø¨Ø± localStorage /
let sessionsDB = JSON.parse(localStorage.getItem("sessionsDB") || "[]");
let currentSessionId = null;
let showControls = false;
let sortAsc = true;

/ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© /
function saveDB(){ localStorage.setItem("sessionsDB", JSON.stringify(sessionsDB)); }

/ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙˆØ§Ù„ÙÙ„ØªØ± /
function renderSessionDropdown(list = sessionsDB){
  const select = document.getElementById("sessionSelect");
  select.innerHTML = "<option value=''>-- Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø© --</option>";
  list.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = ${s.name} (${s.date});
    select.appendChild(opt);
  });
  renderProgramFilter();
  renderTable(list);
}

/ Ø¨Ù†Ø§Ø¡ ÙÙ„ØªØ± Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ /
function renderProgramFilter(){
  const programs = [...new Set(sessionsDB.map(s=>s.program).filter(Boolean))];
  const filter = document.getElementById("programFilter");
  filter.innerHTML = "<option value=''>-- ÙƒÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ --</option>";
  programs.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    filter.appendChild(opt);
  });
}

/ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© /
function selectSession(){
  const id = document.getElementById("sessionSelect").value;
  if(!id){ document.getElementById("sessionDetails").style.display="none"; currentSessionId = null; return; }
  showSessionDetails(Number(id));
}

/ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© (Ø§Ø³Ù…ØŒ ØªØ§Ø±ÙŠØ®ØŒ ÙˆØµÙØŒ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆÙ‚ÙˆÙØŒ Ù†Ù‚Ø·Ø© Ø§Ù„Ø²ÙŠØ±Ùˆ) /
function showSessionDetails(id){
  const s = sessionsDB.find(x=>x.id===id);
  if(!s) return;
  currentSessionId = id;
  document.getElementById("sessionDetails").style.display = "block";
  const standPoint = (s.points || []).find(p=>p.type==="stand");
  const zeroPoint = (s.points || []).find(p=>p.type==="zero");

  document.getElementById("sessionInfo").innerText =
    `Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©: ${s.name}
Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: ${s.program}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${s.date}
Ø§Ù„ÙˆØµÙ: ${s.notes || "-"}`;

  // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: Ø§Ù„ÙˆÙ‚ÙˆÙ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø§Ù„Ø²ÙŠØ±Ùˆ Ø«Ø§Ù†ÙŠØ§Ù‹ØŒ ÙØ§ØµÙ„ ØºØ§Ù…Ù‚ØŒ Ø«Ù… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·
  let html = "<table style='width:100%'><tr><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th><th>X</th><th>Y</th><th>Ø²Ø§ÙˆÙŠØ©</th><th>Ù…Ø³Ø§ÙØ©</th></tr>";

  if(standPoint){
    html += `<tr>
      <td>Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆÙ‚ÙˆÙ (${escapeHtml(standPoint.name)})</td>
      <td>${formatVal(standPoint.x)}</td>
      <td>${formatVal(standPoint.y)}</td>
      <td>${formatAngleOrPlaceholder(standPoint.angle)}</td>
      <td>${formatDistOrPlaceholder(standPoint.dist)}</td>
    </tr>`;
  }

  if(zeroPoint){
    html += `<tr>
      <td>Ù†Ù‚Ø·Ø© Ø§Ù„Ø²ÙŠØ±Ùˆ (${escapeHtml(zeroPoint.name)})</td>
      <td>${formatVal(zeroPoint.x)}</td>
      <td>${formatVal(zeroPoint.y)}</td>
      <td>${formatAngleOrPlaceholder(zeroPoint.angle)}</td>
      <td>${formatDistOrPlaceholder(zeroPoint.dist)}</td>
    </tr>`;
  }

  const otherPoints = (s.points || []).filter(p=>p.type!=="stand" && p.type!=="zero");
  if(otherPoints.length){
    html += <tr class="separator-row"><td colspan="5">Ù†Ù‚Ø§Ø· Ø£Ø®Ø±Ù‰</td></tr>;
    otherPoints.forEach(p=>{
      html += `<tr>
        <td>${escapeHtml(p.name || "-")}</td>
        <td>${formatVal(p.x)}</td>
        <td>${formatVal(p.y)}</td>
        <td>${p.angle !== undefined ? p.angle : "-"}</td>
        <td>${p.dist !== undefined ? p.dist : "-"}</td>
      </tr>`;
    });
  }

  html += "</table>";
  document.getElementById("sessionPoints").innerHTML = html;
}

/ Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠÙ… /
function formatVal(v){ return (v === undefined || v === null || v === "") ? "-" : v; }
function formatAngleOrPlaceholder(a){ return (a === undefined || a === null || a === "") ? "-- Ø¹Ù†Ø¯ Ø§Ù„Ø²Ø§ÙˆÙŠØ©" : a; }
function formatDistOrPlaceholder(d){ return (d === undefined || d === null || d === "") ? "-- Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø§ÙØ©" : d; }
/ Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù…Ù†Ø¹ Ø­Ù‚Ù† HTML Ø¨Ø³ÙŠØ· /
function escapeHtml(str){
  if(!str && str !== 0) return "-";
  return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

/ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« /
function applyFilters(){
  const search = document.getElementById("searchInput").value.trim().toLowerCase();
  const program = document.getElementById("programFilter").value;
  const dateFilter = document.getElementById("dateFilter").value;

  let filtered = sessionsDB.filter(s=>{
    const matchesSearch = !search || (s.name && s.name.toLowerCase().includes(search)) || ((s.program||"").toLowerCase().includes(search));
    return matchesSearch;
  });

  if(program) filtered = filtered.filter(s => s.program === program);

  if(dateFilter === "today"){
    const today = new Date().toLocaleDateString();
    filtered = filtered.filter(s => String(s.date).includes(today));
  } else if(dateFilter === "week"){
    const now = new Date();
    const weekAgo = new Date(); weekAgo.setDate(now.getDate()-7);
    filtered = filtered.filter(s => {
      const d = new Date(s.date);
      return !isNaN(d) ? d >= weekAgo && d <= now : String(s.date).includes(weekAgo.toLocaleDateString());
    });
  }

  filtered.sort((a,b)=>{
    const da = new Date(a.date), db = new Date(b.date);
    if(isNaN(da) || isNaN(db)) return 0;
    return sortAsc ? da - db : db - da;
  });

  renderSessionDropdown(filtered);
}

/ ØªØ¨Ø¯ÙŠÙ„ Ø¸Ù‡ÙˆØ± Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ /
function toggleControls(){
  showControls = !showControls;
  renderTable();
}

/ Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (ÙŠØ³ØªØ®Ø¯Ù… showControls) /
function renderTable(list = sessionsDB){
  const tbody = document.querySelector("#table_sessions tbody");
  const theadRow = document.getElementById("theadRow");
  tbody.innerHTML = "";

  theadRow.innerHTML = showControls
    ? "<th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>ØªØ­ÙƒÙ…</th>"
    : "<th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</th>";

  list.forEach((s,i)=>{
    const tr = document.createElement("tr");
    if(showControls){
      tr.innerHTML = `<td>${i+1}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.program)}</td>
        <td>${escapeHtml(s.date)}</td>
        <td>${(s.points||[]).length}</td>
        <td>
          <button class="btn-ghost" onclick="showSessionDetails(${s.id})">ğŸ‘ Ø¹Ø±Ø¶</button>
          <button class="btn-edit" onclick="editSession(${s.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn-danger" onclick="deleteSession(${s.id})">ğŸ—‘ Ø­Ø°Ù</button>
        </td>`;
    } else {
      tr.innerHTML = `<td>${i+1}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.program)}</td>
        <td>${escapeHtml(s.date)}</td>
        <td>${(s.points||[]).length}</td>`;
    }
    tbody.appendChild(tr);
  });
}

/ ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø­ÙˆØ§Ø± Ø¨Ø³ÙŠØ· Ù…Ø¹ ØªØ£ÙƒÙŠØ¯) /
function editSession(id){
  const s = sessionsDB.find(x=>x.id===id);
  if(!s) return;
  const newName = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ù„Ø³Ø©:", s.name);
  if(newName === null) return;
  const newProgram = prompt("Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:", s.program);
  const newDate = prompt("Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD Ø£Ùˆ Ø£ÙŠ Ù†Øµ):", s.date);
  const newNotes = prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:", s.notes);
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªØŸ")){
    s.name = newName.trim() || s.name;
    s.program = newProgram !== null ? (newProgram.trim() || s.program) : s.program;
    s.date = newDate !== null ? (newDate.trim() || s.date) : s.date;
    s.notes = newNotes !== null ? newNotes.trim() : s.notes;
    saveDB();
    applyFilters();
    showSessionDetails(s.id);
  }
}

/ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ /
function deleteSession(id){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ")) return;
  sessionsDB = sessionsDB.filter(s=>s.id!==id);
  saveDB();
  applyFilters();
  if(currentSessionId === id){
    document.getElementById("sessionDetails").style.display = "none";
    currentSessionId = null;
  }
}

/ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù…Ù† ØªÙØ§ØµÙŠÙ„ /
function confirmDeleteCurrent(){
  if(currentSessionId === null) return;
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ")) deleteSession(currentSessionId);
}

/ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† ØªÙØ§ØµÙŠÙ„ /
function openEditDetails(){
  if(currentSessionId === null) return;
  editSession(currentSessionId);
}

/ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø¥Ù„Ù‰ Excel /
function exportAllSessions(){
  if(!sessionsDB.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
  const data = sessionsDB.map(s => ({
    "Ø§Ù„Ø§Ø³Ù…": s.name,
    "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬": s.program,
    "Ø§Ù„ØªØ§Ø±ÙŠØ®": s.date,
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·": (s.points||[]).length,
    "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": s.notes || ""
  }));
  const ws = XLSX.utils.jsontosheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.bookappendsheet(wb, ws, "Ø§Ù„Ø¬Ù„Ø³Ø§Øª");
  XLSX.writeFile(wb, "Ø§Ù„Ø¬Ù„Ø³Ø§Øª.xlsx");
}

/ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Excel (ØªÙØµÙŠÙ„ÙŠ) /
function exportCurrentSession(){
  if(currentSessionId === null){ alert("Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const s = sessionsDB.find(x=>x.id===currentSessionId);
  if(!s){ alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }

  const pointsData = (s.points && s.points.length) ? s.points.map(p=>({
    "Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù": p.name || "",
    "X": p.x !== undefined ? p.x : "",
    "Y": p.y !== undefined ? p.y : "",
    "Ø²Ø§ÙˆÙŠØ©": p.angle !== undefined ? p.angle : "",
    "Ù…Ø³Ø§ÙØ©": p.dist !== undefined ? p.dist : ""
  })) : [];

  const headerRow = [{
    "Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù": "Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©: " + s.name,
    "X": "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: " + s.program,
    "Y": "Ø§Ù„ØªØ§Ø±ÙŠØ®: " + s.date,
    "Ø²Ø§ÙˆÙŠØ©": "Ù…Ù„Ø§Ø­Ø¸Ø§Øª: " + (s.notes || ""),
    "Ù…Ø³Ø§ÙØ©": "Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆÙ‚ÙˆÙ: " + ((s.points||[]).find(p=>p.type==="stand")?.name || "-") +
              " | Ù†Ù‚Ø·Ø© Ø§Ù„Ø²ÙŠØ±Ùˆ: " + ((s.points||[]).find(p=>p.type==="zero")?.name || "-")
  }];

  const worksheetData = headerRow.concat(pointsData);
  const ws = XLSX.utils.jsontosheet(worksheetData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.bookappendsheet(wb, ws, s.name || "Ø¬Ù„Ø³Ø©");
  const safeName = (s.name || "session").replace(/[\\\/:*?"<>|]/g, "_");
  XLSX.writeFile(wb, safeName + ".xlsx");
}

/ ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ /
function confirmImport(){
  const msg = "âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù„Ù Excel Ø¨Ù†ÙØ³ ØµÙŠØºØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„:\n\n" +
              "Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ | Ø§Ù„ØªØ§Ø±ÙŠØ® | Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· | Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n\n" +
              "Ù‡Ù„ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØºØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŸ";
  if(confirm(msg)) document.getElementById("importExcel").click();
}

/ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel /
function importExcel(){
  const file = document.getElementById("importExcel").files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:"array"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const imported = XLSX.utils.sheettojson(ws, {defval:""});

      let added = 0;
      imported.forEach(row=>{
        const name = row["Ø§Ù„Ø§Ø³Ù…"] || row["Name"] || row["Ø§Ø³Ù…"];
        const program = row["Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬"] || row["Program"] || "Ø¹Ø§Ù…";
        const date = row["Ø§Ù„ØªØ§Ø±ÙŠØ®"] || row["Date"] || new Date().toLocaleDateString();
        const notes = row["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"] || row["Notes"] || "";

        if(name){
          sessionsDB.push({
            id: Date.now() + Math.floor(Math.random()*1000),
            name: String(name),
            program: String(program),
            date: String(date),
            points: [],
            notes: String(notes)
          });
          added++;
        }
      });

      if(added){
        saveDB();
        applyFilters();
        alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ " + added + " Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­");
      } else {
        alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù.");
      }
    } catch(err){
      console.error(err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ù„Ù Excel ØµØ§Ù„Ø­.");
    } finally {
      document.getElementById("importExcel").value = "";
    }
  };
  reader.readAsArrayBuffer(file);
}

/ ØªØ±ØªÙŠØ¨ Ø¹ÙƒØ³ÙŠ/ØªØµØ§Ø¹Ø¯ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® /
function toggleSortOrder(){
  sortAsc = !sortAsc;
  sessionsDB.sort((a,b)=>{
    const da = new Date(a.date), db = new Date(b.date);
    if(isNaN(da) || isNaN(db)) return 0;
    return sortAsc ? da - db : db - da;
  });
  applyFilters();
}

/ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© /
document.addEventListener("DOMContentLoaded", function(){
  renderSessionDropdown();
});
</script>
</body>
</html>
`